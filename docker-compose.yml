services:

  redis:
    image: redis:latest
    container_name: wpp_bot_redis
    restart: always
    ports:
      - '6379:6379'
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

  waha:
    image: devlikeapro/waha:latest
    container_name: wpp_bot_waha
    restart: always
    depends_on:
      - redis
    environment:
      - WAHA_PRINT_QR=false
    ports:
      - '3000:3000'

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: wpp_bot_api
    ports:
      - '5000:5000'
    volumes:
      - .:/app
      - ./chroma_data:/app/chroma_data
    depends_on:
      - redis
      - waha
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=gpt-3.5-turbo
      - OPENAI_TEMPERATURE=0.7
      - OPENAI_EMBEDDING_MODEL=text-embedding-3-small
      - RAG_SEARCH_K=30
      - RAG_CHUNK_SIZE=1000
      - RAG_CHUNK_OVERLAP=200
      - RAG_DATA_DIR=/app/rag/data
      - CHROMA_PERSIST_DIR=/app/chroma_data
      - WAHA_API_URL=http://waha:3000
      - WAHA_SESSION=default
      - REDIS_URL=redis://redis:6379
      - BUFFER_KEY_SUFIX=:buffer
      - DEBOUNCE_SECONDS=10
      - BUFFER_TTL=300
      - MAX_HISTORY_MESSAGES=100
      - HISTORY_TTL_HOURS=168

volumes:
  redis_data:
